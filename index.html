<!DOCTYPE html>
<html lang="en">
<head>
    <title>Jungel</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="stylesheet" href="style.css">
</head>

<body>
<div id="container"><br /><br /><br /><br /><br />Generating world...</div>
<div id="info"><a href="http://threejs.org" target="_blank">three.js</a> - webgl terrain demo<br />(left click: forward, right click: backward)</div>

<script src="bower_components/three.js/build/three.min.js"></script>
<script src="bower_components/three.js/build/three.js"></script>
<script src="bower_components/three.js/examples/js/loaders/OBJLoader.js"></script>
<script src="bower_components/three.js/examples/js/loaders/DDSLoader.js"></script>
<script src="bower_components/three.js/examples/js/loaders/MTLLoader.js"></script>
<script src="bower_components/three.js/examples/js/loaders/OBJMTLLoader.js"></script>
<script src="bower_components/three.js/examples/js/controls/FirstPersonControls.js"></script>
<script src="bower_components/three.js/examples/js/controls/OrbitControls.js"></script>
<script src="bower_components/three.js/examples/js/ImprovedNoise.js"></script>
<script src="bower_components/three.js/examples/js/Detector.js"></script>
<script src="bower_components/three.js/examples/js/libs/stats.min.js"></script>
<script src="bower_components/three.js/examples/js/libs/dat.gui.min.js"></script>
<script src="bower_components/three.js/examples/js/objects/ShadowMesh.js"></script>
<script src="bower_components/three.js/examples/js/postprocessing/BloomPass.js"></script>

<script src="src/HeightMapGeometry.js"></script>
<script src="src/HeightMapMesh.js"></script>
<script src="src/DayNightCycle.js"></script>
<script src="src/GenerateMap.js"></script>
<script src="src/GenerateObjects.js"></script>
<script src="src/GenerateTexture.js"></script>
<script src="src/Mirror.js"></script> 
<script src="src/Water.js"></script>
<script src="src/SoundFX.js"></script>
<script src="src/MovementAndCamera.js"></script>

<script id="vertex-shader" type="x-shader/x-vertex">
    // Other attributes and uniforms are supposed to be filled in by Three.js
    // To avoid it being filled in automatically, use RawShaderMaterial
    attribute vec3 translate;
    varying vec2 vUV;
    void main() {
        <!--vec4 mvPosition = modelViewMatrix * vec4( translate + position, 1.0 );-->
        vec4 pos = vec4(position, 1.0);
        vUV = uv;
        gl_Position = projectionMatrix * modelViewMatrix * pos;
    }
</script>

<script id="fragment-shader" type="x-shader/x-fragment">
    // Other attributes and uniforms are supposed to be filled in by Three.js
    // To avoid it being filled in automatically, use RawShaderMaterial
    uniform sampler2D texture;
    varying vec2 vUV;
    <!--uniform vec3 color;-->
    void main() {
        vec4 sample = texture2D(texture, vUV);
        gl_FragColor = vec4(sample.xyz, sample.w);
    }
</script>

<script>
    "use strict";

    var container, stats;
    var camera, controls, scene, renderer, composer;
    var x, y, z;
    var x2, y2, z2;
    var flag = false;
    // Probably GenerateMap
    var groundData, groundMesh, groundTexture, groundMapImage, groundGeometry,
            mountainData, mountainMesh, mountainTexture, mountainMapImage, mountainGeometry,
            lavaMesh, lavaTexture,lavaGeometry,
            beachData, beachMesh, beachTexture, beachMapImage, beachGeometry;
    var water;
    var waterMesh;
    var frameTime;
    var angle = 0.0;
    var growthLowerLevel;
    var growthUpperLevel;
    var waterNormals;

    var worldWidth, worldHeight ,
            worldHalfWidth, worldHalfHeight;
    var clock = new THREE.Clock();

    window.onload = function() {
        init();
        animate();
    };

    var parameters = {
        width: 2000,
        height: 2000,
        widthSegments: 250,
        heightSegments: 250,
        depth: 1500,
        param: 4,
        filterparam: 1
    };

    function init() {

        ////////////////////////////////////////////////////////
        //                   Initiation                      //
        //////////////////////////////////////////////////////
        container = document.getElementById('container');
        camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 300000);
        camera.name = 'camera';
        scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0XFFFFFF, 0.0000085);
        controls = new THREE.FirstPersonControls(camera);
        controls.movementSpeed = 1500;
        controls.lookSpeed = 0.1;

        ///////////////////////////////////////////////////////
        //                      Renderer                    //
        /////////////////////////////////////////////////////
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true } );
        renderer.setClearColor( 0xbfd1e5 );
        renderer.setPixelRatio( window.devicePixelRatio );
        renderer.setSize( window.innerWidth, window.innerHeight );
        renderer.autoClear = false;
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.shadowDarkness = 1.0;
        container.innerHTML = "";
        container.appendChild( renderer.domElement );
        stats = new Stats();
        stats.domElement.style.position = 'absolute';
        stats.domElement.style.top = '0px';
        container.appendChild( stats.domElement );

        var generateMap = new GenerateMap();
        var dayNightCycle = new DayNightCycle();
        var ambientLight = dayNightCycle.createAmbientLight();
        scene.add(ambientLight);

        ///////////////////////////////////////////////////////
        //                      Meshes                      //
        /////////////////////////////////////////////////////
        var generateTexture = new GenerateTexture();
        generateTexture.terrain(generateMap);
        generateTexture.mountain(generateMap);
        generateTexture.lava();
        generateTexture.beach(generateMap);
        generateTexture.water(ambientLight);

        camera.position.x = -6000;
        camera.position.z = 6900;
        camera.position.y = groundMesh.getHeightAtPoint(camera.position) + 350;

        window.addEventListener( 'resize', onWindowResize, false );

        ///////////////////////////
        //   Correct methods    //
        /////////////////////////
        var generateObjects = new GenerateObjects();
        var movementAndCamera = new MovementAndCamera();
        var soundFX = new SoundFX();


        dayNightCycle.sunLight();
        dayNightCycle.skybox();
        generateObjects.billboard();
        generateObjects.palms3D();
        generateObjects.plants3D();
        generateObjects.ship();
        movementAndCamera.createSpline();
        soundFX.jungleSounds();
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize( window.innerWidth, window.innerHeight );
        controls.handleResize();
    }

    function animate() {
        requestAnimationFrame( animate );
        angle +=0.00001;
        //sunLight.update(angle); 
        water.material.uniforms.time.value += angle;
        //lensFlare.position.set(sunLight.object3d.position.x, sunLight.object3d.position.y, sunLight.object3d.position.z);
        lavaMesh.rotation.z += 0.01;
        x = camera.position.x;
        y = camera.position.y;
        z = camera.position.z;
        if((x2 === x) && (y2 === y) && (z2 === z) ) {
            flag = false;
        } else {
            flag = true;
        }
        if(flag) {
            console.log(Math.round(x), Math.round(y), Math.round(z) );
        }
        render();
        stats.update();
    }

    function render() {
        //        renderer.clear(); //nullstiller alle fargebuffere etc 
        controls.update(clock.getDelta());
        x2 = x;
        y2 = y;
        z2 = z;
        water.render();
        renderer.render( scene, camera );
    }

    function onProgress( xhr ) {
        if ( xhr.lengthComputable ) {
            var percentComplete = xhr.loaded / xhr.total * 100;
            console.log( Math.round(percentComplete, 2) + '% downloaded' );
        }
    }

    function onError( xhr ) {}

</script>

<img src="textures/groundMap.jpeg" id="groundmap" hidden/>
<img src="textures/mountainmap.jpeg" id="mountainmap" hidden/>
<img src="textures/lavamap.jpeg" id="lavamap" hidden/>
<img src="textures/beachMap.jpeg" id="beachmap" hidden/>

</body>
</html>