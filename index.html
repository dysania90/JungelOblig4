<!DOCTYPE html>
<html lang="en">
<head>
    <title>Jungel</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="stylesheet" href="style.css">
</head>

<body>
<div id="container"><br /><br /><br /><br /><br />Generating world...</div>
<div id="info"><a href="http://threejs.org" target="_blank">three.js</a> - webgl terrain demo<br />(left click: forward, right click: backward)</div>

<script src="bower_components/three.js/build/three.min.js"></script>
<script src="bower_components/three.js/build/three.js"></script>
<script src="bower_components/three.js/examples/js/loaders/OBJLoader.js"></script>
<script src="bower_components/three.js/examples/js/loaders/DDSLoader.js"></script>
<script src="bower_components/three.js/examples/js/loaders/MTLLoader.js"></script>
<script src="bower_components/three.js/examples/js/loaders/OBJMTLLoader.js"></script>
<script src="bower_components/three.js/examples/js/controls/FirstPersonControls.js"></script>
<script src="bower_components/three.js/examples/js/controls/OrbitControls.js"></script>
<script src="bower_components/three.js/examples/js/ImprovedNoise.js"></script>
<script src="bower_components/three.js/examples/js/Detector.js"></script>
<script src="bower_components/three.js/examples/js/CurveExtras.js"></script>
<script src="bower_components/three.js/examples/js/libs/stats.min.js"></script>
<script src="bower_components/three.js/examples/js/libs/dat.gui.min.js"></script>
<script src="bower_components/three.js/examples/js/objects/ShadowMesh.js"></script>
<script src="bower_components/three.js/examples/js/postprocessing/BloomPass.js"></script>

<script src="src/HeightMapGeometry.js"></script>
<script src="src/HeightMapMesh.js"></script>
<script src="src/DayNightCycle.js"></script>
<script src="src/GenerateMap.js"></script>
<script src="src/GenerateObjects.js"></script>
<script src="src/GenerateTexture.js"></script>
<script src="src/Mirror.js"></script> 
<script src="src/Water.js"></script>
<script src="src/SoundFX.js"></script>
<script src="src/MovementAndCamera.js"></script>
<script src="src/Renderer.js"></script>
<script src="src/Lava.js"></script>

<script id="vertex-shader" type="x-shader/x-vertex">
    // Other attributes and uniforms are supposed to be filled in by Three.js
    // To avoid it being filled in automatically, use RawShaderMaterial
    attribute vec3 translate;
    varying vec2 vUV;
    void main() {
        <!--vec4 mvPosition = modelViewMatrix * vec4( translate + position, 1.0 );-->
        vec4 pos = vec4(position, 1.0);
        vUV = uv;
        gl_Position = projectionMatrix * modelViewMatrix * pos;
    }
</script>

<script id="fragment-shader" type="x-shader/x-fragment">
    // Other attributes and uniforms are supposed to be filled in by Three.js
    // To avoid it being filled in automatically, use RawShaderMaterial
    uniform sampler2D texture;
    varying vec2 vUV;
    <!--uniform vec3 color;-->
    void main() {
        vec4 sample = texture2D(texture, vUV);
        gl_FragColor = vec4(sample.xyz, sample.w);
    }
</script>

<script>
    "use strict";

    var container, stats;
    var camera,  controls, scene, renderer, composer;

    var flag = false;
    var shadowsEnabled = false;
    var splineVisible = false;
    var dayNightCycle;
    var lensFlare;
    var sunLight;
    var lavaMesh;
    var water;
    var growthLowerLevel;
    var growthUpperLevel;
    var frameTime;
    var angle = 0.0;
    var worldWidth, worldHeight , worldHalfWidth, worldHalfHeight;
    var clock = new THREE.Clock();
    var lava;

    window.onload = function() {
        init();
        animate();
    };

    function init() {
        ////////////////////////////////////////////////////////
        //                   Initiation                      //
        //////////////////////////////////////////////////////
        container = document.getElementById('container');
        camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 300000);
        camera.name = 'camera';
        scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0XFFFFFF, 0.0000085);
        controls = new THREE.FirstPersonControls(camera);
        controls.movementSpeed = 1500;
        controls.lookSpeed = 0.1;
        var renderer = new Renderer();
        renderer.renderer();
        var generateMap = new GenerateMap();
        dayNightCycle = new DayNightCycle();
        var ambientLight = dayNightCycle.createAmbientLight();
        var generateTexture = new GenerateTexture();
        scene.add(ambientLight);

        generateTexture.terrain(generateMap);
        generateTexture.mountain(generateMap);
        lavaMesh = generateTexture.lava();
        scene.add(lavaMesh);
        lava = new Lava();
        lava.initiateLava(lavaMesh);
        generateTexture.beach(generateMap);
        generateTexture.water(ambientLight);

       //position.x = -6000;
        //camera.position.z = 6900;
        //camera.position.y = groundMesh.getHeightAtPoint(camera.position) + 350;

        window.addEventListener( 'resize', onWindowResize, false );

        ///////////////////////////
        //   Correct methods    //
        /////////////////////////
        var generateObjects = new GenerateObjects();
        var movementAndCamera = new MovementAndCamera();
        var soundFX = new SoundFX();
        movementAndCamera.setCamera(-6000,6900);

        dayNightCycle.skybox();
        scene.add(dayNightCycle.sunLight());
        scene.add(dayNightCycle.lensFlare());

        generateObjects.billboard();
        generateObjects.palms3D();
        generateObjects.plants3D();
        generateObjects.ship();

        movementAndCamera.setCamera(-6000, 6900);

        if(splineVisible) {
            movementAndCamera.createSpline();
        }

        soundFX.jungleSounds();

        window.addEventListener( 'resize', onWindowResize, false );
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize( window.innerWidth, window.innerHeight );
        controls.handleResize();
    }

    function animate() {
        requestAnimationFrame( animate );
        lava.updateRain();

        angle +=0.00001;
        //dayNightCycle.sunUpdate(angle); 
        water.material.uniforms.time.value += angle;
        lavaMesh.rotation.z += 0.01;
        //lensFlare.position.set(sunLight.position.x, sunLight.position.y, sunLight.position.z);

        render();
        stats.update();
    }

    function render() {
        //        renderer.clear(); //nullstiller alle fargebuffere etc 
        controls.update(clock.getDelta());


        water.render();
        renderer.render( scene, camera );
    }

    function onProgress( xhr ) {
        if ( xhr.lengthComputable ) {
            var percentComplete = xhr.loaded / xhr.total * 100;
            console.log( Math.round(percentComplete, 2) + '% downloaded' );
        }
    }

    function onError( xhr ) {}

</script>

<img src="textures/groundMap.jpeg" id="groundmap" hidden/>
<img src="textures/mountainmap.jpeg" id="mountainmap" hidden/>
<img src="textures/lavamap.jpeg" id="lavamap" hidden/>
<img src="textures/beachMap.jpeg" id="beachmap" hidden/>

</body>
</html